/*
 * Simple JavaScript Inheritance
 * http://ejohn.org/blog/simple-javascript-inheritance/
 *
 * By John Resig
 * Released into the public domain?
 *
 * Inspired by base2 and Prototype
 */
(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(g){var f=this.prototype;a=true;var e=new this();a=false;for(var d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,i){return function(){var k=this._super;this._super=f[h];var j=i.apply(this,arguments);this._super=k;return j}})(d,g[d]):g[d]}function c(){if(!a&&this.init){this.init.apply(this,arguments)}}c.prototype=e;c.constructor=c;c.extend=arguments.callee;return c}})();
/*
 * Interchange File Format library
 *
 * Copyright (c) 2003-2009 The Gnusto Contributors
 * Licenced under the GPL v2
 * http://github.com/curiousdannii/gnusto
 */
(function(){function c(i,j){return i[j]<<24|i[j+1]<<16|i[j+2]<<8|i[j+3]}function d(i){return[(i>>24)&255,(i>>16)&255,(i>>8)&255,i&255]}function f(j,k){var i=String.fromCharCode;return i(j[k])+i(j[k+1])+i(j[k+2])+i(j[k+3])}function h(i){return[i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]}var b="FORM",g=Class.extend({init:function a(m){this.type="";this.chunks=[];if(m){if(f(m,0)!=b){throw new Error("Not an IFF file")}this.type=f(m,8);var k=12,j=m.length;while(k<j){var n=c(m,k+4);if(n<0||(n+k)>j){throw new Error("IFF: Chunk out of range")}this.chunks.push({type:f(m,k),offset:k,data:m.slice(k+8,k+8+n)});k+=8+n;if(n%2){k++}}}},write:function e(){var n=h(this.type);for(var o=0,k=this.chunks.length;o<k;o++){var m=this.chunks[o],p=m.data,j=p.length;n=n.concat(h(m.type),d(j),p);if(j%2){n.push(0)}}return h(b).concat(d(n.length),n)}});g.num_from=c;g.num_to_word=d;g.text_from=f;g.text_to_word=h;window.IFF=g})();
/*
 * Copyright (c) 2006 Brandon Aaron (brandon.aaron@gmail.com || http://brandonaaron.net)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 * Thanks to: http://adomas.org/javascript-mouse-wheel/ for some pointers.
 * Thanks to: Mathias Bank(http://www.mathias-bank.de) for a scope bug fix.
 *
 * $LastChangedDate: 2007-12-20 09:02:08 -0600 (Thu, 20 Dec 2007) $
 * $Rev: 4265 $
 *
 * Version: 3.0
 * 
 * Requires: $ 1.2.2+
 */
(function(a){a.event.special.mousewheel={setup:function(){var b=a.event.special.mousewheel.handler;if(a.browser.mozilla){a(this).bind("mousemove.mousewheel",function(c){a.data(this,"mwcursorposdata",{pageX:c.pageX,pageY:c.pageY,clientX:c.clientX,clientY:c.clientY})})}if(this.addEventListener){this.addEventListener((a.browser.mozilla?"DOMMouseScroll":"mousewheel"),b,false)}else{this.onmousewheel=b}},teardown:function(){var b=a.event.special.mousewheel.handler;a(this).unbind("mousemove.mousewheel");if(this.removeEventListener){this.removeEventListener((a.browser.mozilla?"DOMMouseScroll":"mousewheel"),b,false)}else{this.onmousewheel=function(){}}a.removeData(this,"mwcursorposdata")},handler:function(d){var b=Array.prototype.slice.call(arguments,1);d=a.event.fix(d||window.event);a.extend(d,a.data(this,"mwcursorposdata")||{});var e=0,c=true;if(d.wheelDelta){e=d.wheelDelta/120}if(d.detail){e=-d.detail/3}if(a.browser.opera){e=-d.wheelDelta}d.data=d.data||{};d.type="mousewheel";b.unshift(e);b.unshift(d);return a.event.handle.apply(this,b)}};a.fn.extend({mousewheel:function(b){return b?this.bind("mousewheel",b):this.trigger("mousewheel")},unmousewheel:function(b){return this.unbind("mousewheel",b)}})})(jQuery);
/*
(c) Copyrights 2007 - 2008

Original idea by by Binny V A, http://www.openjs.com/scripts/events/keyboard_shortcuts/
 
jQuery Plugin by Tzury Bar Yochay 
tzury.by@gmail.com
http://evalinux.wordpress.com
http://facebook.com/profile.php?id=513676303

Project's sites: 
http://code.google.com/p/js-hotkeys/
http://github.com/tzuryby/hotkeys/tree/master

License: same as jQuery license. 
*/
(function(b){b.fn.__bind__=b.fn.bind;b.fn.__unbind__=b.fn.unbind;b.fn.__find__=b.fn.find;var a={version:"0.7.8",override:/keydown|keypress|keyup/g,triggersMap:{},specialKeys:{27:"esc",9:"tab",32:"space",13:"return",8:"backspace",145:"scroll",20:"capslock",144:"numlock",19:"pause",45:"insert",36:"home",46:"del",35:"end",33:"pageup",34:"pagedown",37:"left",38:"up",39:"right",40:"down",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12"},shiftNums:{"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"},newTrigger:function(e,d,f){var c={};c[e]={};c[e][d]={cb:f,disableInInput:false};return c}};if(b.browser.mozilla){a.specialKeys=b.extend(a.specialKeys,{96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9"})}b.fn.find=function(c){this.query=c;return b.fn.__find__.apply(this,arguments)};b.fn.unbind=function(h,e,g){if(b.isFunction(e)){g=e;e=null}if(e&&typeof e==="string"){var f=((this.prevObject&&this.prevObject.query)||(this[0].id&&this[0].id)||this[0]).toString();var d=h.split(" ");for(var c=0;c<d.length;c++){delete a.triggersMap[f][d[c]][e]}}return this.__unbind__(h,g)};b.fn.bind=function(j,f,k){var h=j.match(a.override);if(b.isFunction(f)||!h){return this.__bind__(j,f,k)}else{var n=null,i=b.trim(j.replace(a.override,""));if(i){n=this.__bind__(i,f,k)}if(typeof f==="string"){f={combi:f}}if(f.combi){for(var m=0;m<h.length;m++){var d=h[m];var g=f.combi.toLowerCase(),e=a.newTrigger(d,g,k),l=((this.prevObject&&this.prevObject.query)||(this[0].id&&this[0].id)||this[0]).toString();e[d][g].disableInInput=f.disableInInput;if(!a.triggersMap[l]){a.triggersMap[l]=e}else{if(!a.triggersMap[l][d]){a.triggersMap[l][d]=e[d]}}var c=a.triggersMap[l][d][g];if(!c){a.triggersMap[l][d][g]=[e[d][g]]}else{if(c.constructor!==Array){a.triggersMap[l][d][g]=[c]}else{a.triggersMap[l][d][g][c.length]=e[d][g]}}this.each(function(){var o=b(this);if(o.attr("hkId")&&o.attr("hkId")!==l){l=o.attr("hkId")+";"+l}o.attr("hkId",l)});n=this.__bind__(h.join(" "),f,a.handler)}}return n}};a.findElement=function(c){if(!b(c).attr("hkId")){if(b.browser.opera||b.browser.safari){while(!b(c).attr("hkId")&&c.parentNode){c=c.parentNode}}}return c};a.handler=function(e){var o=a.findElement(e.currentTarget),i=b(o),d=i.attr("hkId");if(d){d=d.split(";");var g=e.which,q=e.type,p=a.specialKeys[g],n=!p&&String.fromCharCode(g).toLowerCase(),h=e.shiftKey,c=e.ctrlKey,m=e.altKey||e.originalEvent.altKey,f=null;for(var r=0;r<d.length;r++){if(a.triggersMap[d[r]][q]){f=a.triggersMap[d[r]][q];break}}if(f){var j;if(!h&&!c&&!m){j=f[p]||(n&&f[n])}else{var l="";if(m){l+="alt+"}if(c){l+="ctrl+"}if(h){l+="shift+"}j=f[l+p];if(!j){if(n){j=f[l+n]||f[l+a.shiftNums[n]]||(l==="shift+"&&f[a.shiftNums[n]])}}}if(j){var s=false;for(var r=0;r<j.length;r++){if(j[r].disableInInput){var k=b(e.target);if(i.is("input")||i.is("textarea")||k.is("input")||k.is("textarea")){return true}}s=s||j[r].cb.apply(this,[e])}return s}}}};window.hotkeys=a;return b})(jQuery);function Querystring(a){this.params={};this.get=Querystring_get;if(a==null){}a=location.search.substring(1,location.search.length);if(a.length==0){return}a=a.replace(/\+/g," ");var c=a.split("&");for(var d=0;d<c.length;d++){var f=c[d].split("=");var b=unescape(f[0]);var e=(f.length==2)?unescape(f[1]):b;this.params[b]=e}}function Querystring_get(a,b){var c=this.params[a];return(c!=null)?c:b}
/*
 * Taken from "Remedial Javascript" by Douglas Crockford:
 * http://javascript.crockford.com/remedial.html
 */
function typeOf(b){var a=typeof b;if(a==="object"){if(b){if(typeof b.length==="number"&&!(b.propertyIsEnumerable("length"))&&typeof b.splice==="function"){a="array"}}else{a="null"}}return a}function isEmpty(c){var b,a;if(typeOf(c)==="object"){for(b in c){a=c[b];if(a!==undefined&&typeOf(a)!=="function"){return false}}}return true}String.prototype.entityify=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};String.prototype.quote=function(){var e,b,a=this.length,d='"';for(b=0;b<a;b+=1){e=this.charAt(b);if(e>=" "){if(e==="\\"||e==='"'){d+="\\"}d+=e}else{switch(e){case"\b":d+="\\b";break;case"\f":d+="\\f";break;case"\n":d+="\\n";break;case"\r":d+="\\r";break;case"\t":d+="\\t";break;default:e=e.charCodeAt();d+="\\u00"+Math.floor(e/16).toString(16)+(e%16).toString(16)}}}return d+'"'};String.prototype.supplant=function(a){return this.replace(/{([^{}]*)}/g,function(d,c){var e=a[c];return typeof e==="string"||typeof e==="number"?e:d})};String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};function FatalError(a){this.message=a;this.traceback=this._makeTraceback(arguments.callee);this.onError(this)}FatalError.prototype={onError:function(a){},_makeTraceback:function(a){var d="";var c=0;var b=100;while(a!=null&&c<b){var f=a.toString();if(!f){d="\n  (anonymous function)"+d}else{var g=f.match(/function (\w*)/);if(!g||!g[1]){d="\n  (anonymous function)"+d}else{d="\n  "+g[1]+d}}try{a=a.caller}catch(h){a=null}c++}if(c==b){d="..."+d}return"Traceback (most recent call last):\n"+d}};(function(){var c="IFZS",d="IFhd",a="CMem",b="UMem",g="Stks";window.Quetzal=IFF.extend({init:function f(j){this._super(j);if(j){if(this.type!=c){throw new Error("Not a Quetzal savefile")}for(var k=0,h=this.chunks.length;k<h;k++){var m=this.chunks[k].type,n=this.chunks[k].data;if(m==a||m==b){this.memory=n;this.compressed=(m==a)}else{if(m==g){this.stacks=n}else{if(m==d){this.release=n.slice(0,2);this.serial=n.slice(2,8);this.checksum=n.slice(8,10);this.pc=n[10]<<16|n[11]<<8|n[12]}}}}}},write:function e(){this.type=c;var i=this.pc,h=this.release.concat(this.serial,this.checksum,(i>>16)&255,(i>>8)&255,i&255);this.chunks=[{type:d,data:h},{type:(this.compressed?a:b),data:this.memory},{type:g,data:this.stacks}];return this._super()}})})();
/*
 * Parchment
 *
 * Copyright (c) 2003-2009 The Parchment Contributors
 * Licenced under the GPL v2
 * http://code.google.com/p/parchment
 */
$.ajaxSetup({cache:true});var parchment={};(function(e){var f=function(k,m){var m=m||[],j=0,h;for(h=k.length%16;j<h;++j){m.push(k.charCodeAt(j))}for(h=k.length;j<h;){m.push(k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++),k.charCodeAt(j++))}return m},d=function(n,m){var m=m||"",k=0,h,j=String.fromCharCode;for(h=n.length%8;k<h;++k){m+=j(n[k])}for(h=n.length;k<h;){m+=(j(n[k++])+j(n[k++])+j(n[k++])+j(n[k++])+j(n[k++])+j(n[k++])+j(n[k++])+j(n[k++]))}return m};if(e.atob){var c=function(i,h){var h=h||[];return f(atob(i),h)},a=function(i,h){var h=h||"";return btoa(d(i,h))}}else{var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",g=(function(k){var h=[],j=0;for(;j<k.length;j++){h[k.charAt(j)]=j}return h})(b),c=function(o,m){var m=m||[],p,k,j,t,s,r,q,n=0,h=o.length;while(n<h){t=g[o.charAt(n++)];s=g[o.charAt(n++)];r=g[o.charAt(n++)];q=g[o.charAt(n++)];p=(t<<2)+(s>>4);k=((s&15)<<4)+(r>>2);j=((r&3)<<6)+q;m.push(p,k,j)}if(q==64){m.pop()}if(r==64){m.pop()}return m},a=function(o,m){var m=m||"",p,k,j,t,s,r,q,n=0,h=o.length;while(n<h){p=o[n++];k=o[n++];j=o[n++];t=p>>2;s=((p&3)<<4)+(k>>4);r=((k&15)<<2)+(j>>6);q=j&63;m+=(b.charAt(t)+b.charAt(s)+b.charAt(r)+b.charAt(q))}if(isNaN(k)){m=m.slice(0,-2)+"=="}else{if(isNaN(j)){m=m.slice(0,-1)+"="}}return m}}e.file={text_to_array:f,array_to_text:d,base64_decode:c,base64_encode:a}})(window);(function(){window.gIsIphone=navigator.userAgent.match(/iPhone/i);var b;var a="0";$(document).ready(function(){b=document.getElementById("top-window");a="0";var d=navigator.appVersion.match(/MSIE (\d+)\./);if(d&&+d[1]<7){b.style.position="absolute";var c=function(){b.style.top=1*(document.documentElement.scrollTop+1*a)+"px"};window.onscroll=c;window.onresize=c}})})();function EngineRunner(d,c,e){this._engine=d;this._zui=c;this._isRunning=false;this._isInLoop=false;this._isWaitingForCallback=false;this._log=e;var b=this;var a={stop:function(){b._isRunning=false},run:function(){var f=b._zui.getSize();b._zui.setVersion(b._engine.m_version);b._isRunning=true;b._engine.m_memory[32]=f[1];b._engine.m_memory[33]=f[0];b._continueRunning()},_continueRunning:function(){while(b._isRunning&&!b._isWaitingForCallback){b._loop()}},_receiveLineInput:function(f){b._isWaitingForCallback=false;b._engine.answer(0,13);b._engine.answer(1,f);if(!b._isInLoop){b._continueRunning()}else{}},_receiveCharacterInput:function(f){b._isWaitingForCallback=false;b._engine.answer(0,f);if(!b._isInLoop){b._continueRunning()}else{}},_unWimpOut:function(){b._isWaitingForCallback=false;if(!b._isInLoop){b._continueRunning()}else{}},_loop:function(){if(b._isInLoop){throw new FatalError("Already in loop!")}b._isInLoop=true;var k=b._engine;k.run();var n=k.consoleText();if(n){b._zui.onPrint(n)}var p='"'+k.effect(0)+'"';var g="[ "+k.effect(0);for(var h=1;k.effect(h)!=undefined;h++){var m=k.effect(h);if(typeof m=="string"){m=m.quote()}g+=", "+m}b._log(g+" ]");switch(p){case GNUSTO_EFFECT_INPUT:b._isWaitingForCallback=true;b._zui.onLineInput(b._receiveLineInput);break;case GNUSTO_EFFECT_INPUT_CHAR:b._isWaitingForCallback=true;b._zui.onCharacterInput(b._receiveCharacterInput);break;case GNUSTO_EFFECT_SAVE:k.saveGame();if(b._zui.onSave(k.saveGameData())){k.answer(0,1)}else{k.answer(0,0)}break;case GNUSTO_EFFECT_RESTORE:var q=b._zui.onRestore();if(q){k.loadSavedGame(q)}else{k.answer(0,0)}break;case GNUSTO_EFFECT_QUIT:b.stop();b._zui.onQuit();break;case GNUSTO_EFFECT_RESTART:b.stop();b._zui.onRestart();break;case GNUSTO_EFFECT_WIMP_OUT:b._isWaitingForCallback=true;b._zui.onWimpOut(b._unWimpOut);break;case GNUSTO_EFFECT_BREAKPOINT:throw new FatalError("Unimplemented effect: "+p);case GNUSTO_EFFECT_FLAGS_CHANGED:var j=k.m_printing_header_bits&1;var l=k.m_printing_header_bits&2;b._zui.onFlagsChanged(j,l);break;case GNUSTO_EFFECT_PIRACY:throw new FatalError("Unimplemented effect: "+p);case GNUSTO_EFFECT_STYLE:b._zui.onSetStyle(k.effect(1),k.effect(2),k.effect(3));break;case GNUSTO_EFFECT_SOUND:break;case GNUSTO_EFFECT_SPLITWINDOW:b._zui.onSplitWindow(k.effect(1));break;case GNUSTO_EFFECT_SETWINDOW:b._zui.onSetWindow(k.effect(1));break;case GNUSTO_EFFECT_ERASEWINDOW:b._zui.onEraseWindow(k.effect(1));break;case GNUSTO_EFFECT_ERASELINE:throw new FatalError("Unimplemented effect: "+p);case GNUSTO_EFFECT_SETCURSOR:b._zui.onSetCursor(k.effect(2),k.effect(1));break;case GNUSTO_EFFECT_SETBUFFERMODE:b._zui.onSetBufferMode(k.effect(1));break;case GNUSTO_EFFECT_SETINPUTSTREAM:case GNUSTO_EFFECT_GETCURSOR:throw new FatalError("Unimplemented effect: "+p);break;case GNUSTO_EFFECT_PRINTTABLE:var f=k.effect(1);var o=[];for(h=0;h<f;h++){o.push(k.effect(2+h))}b._zui.onPrintTable(o);break}b._isInLoop=false}};for(name in a){b[name]=a[name]}}function Console(d,a,c,b){this.width=d;this.height=a;this._element=c;this._pos=[0,0];this._observer=b;this._isRenderScheduled=false;this.clear()}Console.prototype={resize:function(a){var b=a-this.height;if(b==0){return}var c;if(b>0){for(c=0;c<b;c++){this._addRow()}}else{for(c=0;c<-b;c++){this._delRow()}}this.height=a;this._scheduleRender()},_delRow:function(){this._characters.pop();this._styles.pop()},_addRow:function(){var b=[];var c=[];for(var a=0;a<this.width;a++){b.push("&nbsp;");c.push(null)}this._characters.push(b);this._styles.push(c)},clear:function(){this._characters=[];this._styles=[];for(var a=0;a<this.height;a++){this._addRow()}this._scheduleRender()},moveTo:function(a,b){this._pos=[a,b]},write:function(b,d){var a=this._pos[0];var f=this._pos[1];for(var c=0;c<b.length;c++){var e=null;if(b.charAt(c)==" "){e="&nbsp;"}else{if(b.charAt(c)=="\n"){a=0;f+=1}else{e=b.charAt(c).entityify()}}if(f>this.height-1){this.resize(f+1)}if(e!=null){this._characters[f][a]=e;this._styles[f][a]=d;a+=1}}this._pos=[a,f];this._scheduleRender()},_scheduleRender:function(){if(!this._isRenderScheduled){this._isRenderScheduled=true;var a=this;window.setTimeout(function(){a._doRender()},0)}},renderHtml:function(){var c="";for(var d=0;d<this.height;d++){var b=null;for(var a=0;a<this.width;a++){if(this._styles[d][a]!==b){if(b!==null){c+="</span>"}b=this._styles[d][a];if(b!==null){c+='<span class="'+b+'">'}}c+=this._characters[d][a]}if(b!==null){c+="</span>"}c+="<br/>"}return c},_doRender:function(){this._element.innerHTML=this.renderHtml();this._isRenderScheduled=false;this._observer.onConsoleRender()},close:function(){this._element.innerHTML="";this._observer.onConsoleRender()}};var ESCAPE_KEYCODE=27;var BACKSPACE_KEYCODE=8;var RETURN_KEYCODE=13;var SHIFT_KEYCODE=16;var LEFT_KEYCODE=37;var UP_KEYCODE=38;var RIGHT_KEYCODE=39;var DOWN_KEYCODE=40;var ZSCII_UP=129;var ZSCII_DOWN=130;var ZSCII_LEFT=131;var ZSCII_RIGHT=132;var ZSCII_NEWLINE=13;var ZSCII_DELETE=8;var ZSCII_ESCAPE=27;var __origKeyCodeHandlerMap={BACKSPACE_KEYCODE:"backwardDeleteChar",LEFT_KEYCODE:"backwardChar",UP_KEYCODE:"previousHistory",RIGHT_KEYCODE:"forwardChar",DOWN_KEYCODE:"nextHistory"};var __originalKeyCodeToZSCIIMap={RETURN_KEYCODE:ZSCII_NEWLINE,BACKSPACE_KEYCODE:ZSCII_DELETE,ESCAPE_KEYCODE:ZSCII_ESCAPE,LEFT_KEYCODE:ZSCII_LEFT,UP_KEYCODE:ZSCII_UP,RIGHT_KEYCODE:ZSCII_RIGHT,DOWN_KEYCODE:ZSCII_DOWN};function constKeysToValues(c,b){var a={};for(name in c){a[b[name]]=c[name]}return a}var keyCodeHandlerMap=constKeysToValues(__origKeyCodeHandlerMap,this);var keyCodeToZSCIIMap=constKeysToValues(__originalKeyCodeToZSCIIMap,this);function LineEditor(){this.line="";this.pos=0;this._history=[""];this._savedHistory={};this._historyPos=0;var a=this;this.acceptLine=function(){var b=a.line;a.line="";a.pos=0;for(var c in a._savedHistory){a._history[c]=a._savedHistory[c]}a._savedHistory={};if(b.length>0){a._history[a._history.length-1]=b;a._history.push("")}a._historyPos=a._history.length-1;return b};this.forwardChar=function(){if(a.pos<a.line.length){a.pos++}};this.backwardChar=function(){if(a.pos>0){a.pos--}};this.backwardDeleteChar=function(){if(a.pos>0){var c=a.line.slice(0,a.pos-1);var b=a.line.slice(a.pos);if(b.charAt(0)==" "&&c.charAt(c.length-1)==" "){b=b.slice(1)}a.line=c+b;a.pos--}};this.selfInsert=function(d){var b=String.fromCharCode(d);if(b==" "){if(a.pos>0&&a.line.charAt(a.pos-1)==" "){return}else{if(a.pos<a.line.length&&a.line.charAt(a.pos)==" "){return}}}a.line=(a.line.slice(0,a.pos)+b+a.line.slice(a.pos));a.pos++};this._saveHistoryExcursion=function(){if(a._history[a._historyPos]!=a._line){if(!(a._historyPos in a._savedHistory)){a._savedHistory[a._historyPos]=a._history[a._historyPos]}a._history[a._historyPos]=a.line}};this.previousHistory=function(){if(a._historyPos<=0){return}a._saveHistoryExcursion();a._historyPos--;a.line=a._history[a._historyPos];a.pos=a.line.length};this.nextHistory=function(){if(a._historyPos+1>=a._history.length){return}a._saveHistoryExcursion();a._historyPos++;a.line=a._history[a._historyPos];a.pos=a.line.length}}function WebZui(e){var a=gIsIphone?38:80;this._size=[a,25];this._console=null;this._activeWindow=0;this._lineEditor=new LineEditor();this._currentCallback=null;this._foreground="default";this._background="default";this._reverseVideo=false;this._lastSeenY=0;this._currStyles=["z-roman"];this._expectedHash=window.location.hash;this._isFixedWidth=false;this._bufferMode=0;this.bottom=$("#bottom");this.current_input=$("#current-input");if(e){this._log=e}else{this._log=function(){}}var c=this;var b={onConsoleRender:function(){var g=$("#top-window").height();$("#content").css({padding:""+g+"px 0 0 0"});c._scrollBottomWindow()},_scrollBottomWindow:function(){if(!gIsIphone){window.scroll(0,c._lastSeenY)}},_finalize:function(){if(c._console){c._console.close();c._console=null}$("#content").empty();c._unbindEventHandlers()},_bindEventHandlers:function(){if(gIsIphone){$(document).keyup(c._iphoneKeyup)}else{$(document).bind("keydown","Ctrl+v",c._windowPasteHandler).keypress(c._windowKeypress).keyup(c._windowKeyup).keydown(c._windowKeydown).mousewheel(c._windowMousewheel)}$(window).resize(c._windowResize);c._intervalId=window.setInterval(c._windowHashCheck,1000)},_unbindEventHandlers:function(){if(gIsIphone){$(document).unbind("keyup",c._iphoneKeyup)}else{$(document).unbind("keydown","Ctrl+v",c._windowPasteHandler).unbind("keypress",c._windowKeypress).unbind("keyup",c._windowKeyup).unbind("keydown",c._windowKeydown).unbind("mousewheel",c._windowMousewheel)}$(window).unbind("resize",c._windowResize);window.clearInterval(c._intervalId)},_windowMousewheel:function(g,h){window.scrollBy(0,-h*5)},_isHotKey:function(g){return(g.altKey||g.ctrlKey||g.metaKey)},_iphoneKeyup:function(g){$("#iphone-text-field").val("");var h=new Object();switch(g.keyCode){case 127:h.keyCode=BACKSPACE_KEYCODE;break;case 10:h.keyCode=RETURN_KEYCODE;break;default:h.charCode=g.keyCode}return c._handleKeyEvent(h)},_windowKeyup:function(g){if(jQuery.browser.mozilla){return c._isHotKey(g)}else{return true}},_windowKeydown:function(g){if(jQuery.browser.mozilla){return c._isHotKey(g)}else{if(((jQuery.browser.safari||jQuery.browser.msie)&&(!jQuery.browser.opera)&&(g.keyCode==LEFT_KEYCODE||g.keyCode==UP_KEYCODE||g.keyCode==RIGHT_KEYCODE||g.keyCode==DOWN_KEYCODE||g.keyCode==BACKSPACE_KEYCODE))){return c._handleKeyEvent(g)}else{return true}}},_windowKeypress:function(g){if(c._isHotKey(g)){return true}if(jQuery.browser.mozilla){return c._handleKeyEvent(g)}else{var h=new Object();if(jQuery.browser.opera){h.charCode=g.which;if(g.which!=LEFT_KEYCODE&&g.which!=RIGHT_KEYCODE&&g.which!=UP_KEYCODE&&g.which!=DOWN_KEYCODE){h.keyCode=g.keyCode}}else{if(jQuery.browser.safari){if(g.charCode&&g.keyCode!=RETURN_KEYCODE){h.charCode=g.charCode}else{h.keyCode=g.keyCode}}else{if(jQuery.browser.msie){if(g.keyCode==RETURN_KEYCODE){h.keyCode=g.keyCode}else{h.charCode=g.keyCode}}}}return c._handleKeyEvent(h)}},_handleKeyEvent:function(g){if(g.keyCode==SHIFT_KEYCODE){return false}c._removeBufferedWindows();c._lastSeenY=c.bottom.offset().top;c._scrollBottomWindow();if(c.current_input.length==0){if(c._currentCallback){var p=0;if(g.charCode){p=g.charCode}else{if(keyCodeToZSCIIMap[g.keyCode]){p=keyCodeToZSCIIMap[g.keyCode]}}if(p!=0){var o=c._currentCallback;c._currentCallback=null;o(p)}}return false}var i=c._lineEditor.line;var h=c._lineEditor.pos;if(g.keyCode==RETURN_KEYCODE){var k=c._lineEditor.acceptLine();var o=c._currentCallback;c._currentCallback=null;c._lastSeenY=c.current_input.offset().top;var q=c.current_input.attr("class");c.current_input.replaceWith(('<span class="finished-input '+q+'">'+k.entityify()+"</span><br/>"));c.current_input=$("#current-input");o(k)}else{if(g.keyCode in keyCodeHandlerMap){c._lineEditor[keyCodeHandlerMap[g.keyCode]]()}else{if(g.charCode){c._lineEditor.selfInsert(g.charCode)}}}if(c.current_input&&(i!=c._lineEditor.line||h!=c._lineEditor.pos)){var j=c._lineEditor.line.slice(0,c._lineEditor.pos);var n;var m;var l;if(c._lineEditor.line.length<=c._lineEditor.pos){n="";m="_";l="cursor"}else{n=c._lineEditor.line.slice(c._lineEditor.pos+1);m=c._lineEditor.line.charAt(c._lineEditor.pos);l="editing-cursor";if(m==" "){m="&nbsp;"}else{m=m.entityify()}}c.current_input.html(j.entityify()+'<span id="'+l+'">'+m+"</span>"+n.entityify())}return false},_windowPasteHandler:function(g){if(c.current_input.length!=0){$("#pasteinput").focus();window.setTimeout(c._inputPasteHandler,10)}},_inputPasteHandler:function(j){var h=$("#pasteinput").val();$("#pasteinput").val("");var k={charCode:0,keyCode:0};for(var g=0;g<h.length;g++){k.charCode=h.charCodeAt(g);c._handleKeyEvent(k)}},_windowResize:function(){var g=$("#content").offset().left+"px";$(".buffered-window").css({left:g})},_windowHashCheck:function(){if(window.location.hash!=c._expectedHash){c._restart()}},_removeBufferedWindows:function(){var g=$("#buffered-windows > .buffered-window");g.fadeOut("slow",function(){g.remove()})},_eraseBottomWindow:function(){$("#content").empty();this._lastSeenY=0},_restart:function(){c._finalize();window.setTimeout(_webZuiStartup,0)},setVersion:function(g){c._version=g},getSize:function(){return c._size},onLineInput:function(i){if(window.engine.m_version<=3){var g=c._activeWindow;var h=this._reverseVideo;if(!c._console){c.onSplitWindow(1)}c._console.moveTo(0,0);c._activeWindow=1;this._reverseVideo=true;c.onPrint(window.engine.getStatusLine(c._console.width));this._reverseVideo=h;c._activeWindow=g}c._currentCallback=i;$("#content").append('<span id="current-input"><span id="cursor">_</span></span>');c.current_input=$("#current-input");c.current_input.attr("class",c._calcFinalStyles())},onCharacterInput:function(g){c._currentCallback=g},onSave:function(i){var h=gStory+"_saveData";var g=file.base64_encode(i);if(window.globalStorage&&location.href.slice(0,5)!="file:"){window.globalStorage[location.hostname][h]=g}window.location.hash="#"+g;c._expectedHash=window.location.hash;c.onPrint("Your game has been saved to the URL. You may want to bookmark this page now; just reload it at any time to restore your game from this point.\n");return true},onRestore:function(){var h=null;if(window.location.hash){h=window.location.hash.slice(1)}if(!h&&window.globalStorage){var g=globalStorage[location.hostname][gStory+"_saveData"];if(g){h=g.value}}if(h){window.location.hash="#"+h;c._expectedHash=window.location.hash;return file.base64_decode(h)}else{return null}},onQuit:function(){c._finalize()},onRestart:function(){c._finalize();window.location.hash="";c._restart()},onWimpOut:function(g){window.setTimeout(g,50)},onFlagsChanged:function(g,h){if(g){throw new FatalError("To transcript not yet implemented!")}c._isFixedWidth=h},onSetStyle:function(j,i,h){switch(j){case -1:break;case 0:this._currStyles=["z-roman"];this._reverseVideo=false;break;case 1:this._reverseVideo=true;break;case 2:this._currStyles.push("z-bold");break;case 4:this._currStyles.push("z-italic");break;case 8:this._currStyles.push("z-fixed-pitch");break;default:throw new FatalError("Unknown style: "+j)}var g={0:null,1:"default",2:"black",3:"red",4:"green",5:"yellow",6:"blue",7:"magenta",8:"cyan",9:"white"};if(g[i]){this._foreground=g[i]}if(g[h]){this._background=g[h]}},onSetWindow:function(g){if(g==1){if(!c._console){c.onSplitWindow(1)}c._console.moveTo(0,0)}c._activeWindow=g},onEraseWindow:function(g){document.body.className="bg-"+c._background;if(g==-2){c._console.clear();c._eraseBottomWindow()}else{if(g==-1){c.onSplitWindow(0);c._eraseBottomWindow()}else{if(g==0){c._eraseBottomWindow()}else{if(g==1&&c._console){c._console.clear()}}}}},onSetCursor:function(g,h){if(c._console){c._console.moveTo(g-1,h-1)}},onSetBufferMode:function(g){c._bufferMode=g},onSplitWindow:function(h){if(h==0){if(c._console){c._console.close();c._console=null}}else{if(!c._console||c._version==3||!c._bufferMode){c._console=new Console(c._size[0],h,$("#top-window").get(0),c)}else{if(c._console.height!=h){var g=document.createElement("div");g.className="buffered-window";g.innerHTML=c._console.renderHtml();$(g).css({width:c._pixelWidth+"px",lineHeight:c._pixelLineHeight+"px"});$("#buffered-windows").append(g);c._windowResize();c._console.resize(h)}}}c._bufferMode=0},_calcFinalStyles:function(){var h=c._foreground;var i=c._background;if(c._reverseVideo){h=c._background;i=c._foreground;if(h=="default"){h="default-reversed"}if(i=="default"){i="default-reversed"}}var g=["fg-"+h,"bg-"+i];if(c._isFixedWidth){g.push("z-fixed-pitch")}return g.concat(c._currStyles).join(" ")},onPrint:function(k){var n=c._calcFinalStyles();c._log("print wind: "+c._activeWindow+" output: "+k.quote()+" style: "+n);if(c._activeWindow==0){var h=k.split("\n");for(var m=0;m<h.length;m++){if(h[m]){var l=h[m].entityify();var j=/ /g,g=/(\S) (\S)/g,o=/<&>/g;l=l.replace(g,"$1<&>$2");l=l.replace(j,"&nbsp;");l=l.replace(o,'<span class="z-breaking-whitespace"> </span>');l='<span class="'+n+'">'+l+"</span>";$("#content").append(l)}if(m<h.length-1){$("#content").append("<br/>")}}c._scrollBottomWindow()}else{c._console.write(k,n)}},onPrintTable:function(g){for(var h=0;h<g.length;h++){c.onPrint(g[h])}},_setFixedPitchSizes:function(){var k=document.createElement("div");k.className="buffered-window";for(var j=0;j<c._size[0];j++){k.innerHTML+="O"}k.innerHTML="<span>"+k.innerHTML+"</span>";$("#buffered-windows").append(k);c._pixelWidth=$(k).width();if(jQuery.browser.msie&&(jQuery.browser.version.length==1||jQuery.browser.version.charAt(1)==".")&&jQuery.browser.version<"7"){var h=-1,g=document.getElementById("top-window").currentStyle.fontSize.toLowerCase();if(g.substring(g.length-2)=="px"){h=0.6*parseInt(g)}else{if(g.substring(g.length-2)=="pt"){h=0.8*parseInt(g)}}if(h>0){c._pixelWidth=c._size[0]*h}}c._pixelLineHeight=$(k.firstChild).height();$("#buffered-windows").empty()}};for(name in b){c[name]=b[name]}c._setFixedPitchSizes();$("#top-window").css({width:c._pixelWidth+"px",lineHeight:c._pixelLineHeight+"px"});$("#content").css({width:c._pixelWidth+"px"});c._windowResize();c._bindEventHandlers();c._eraseBottomWindow();if(gIsIphone){$(document.body).append('<textarea class="iphone-visible" id="iphone-text-field" rows="1" cols="20" autocapitalize="off">Tap here to enter text.</textarea>');var d=-1*$("#iphone-text-field").height();$("#iphone-text-field").css({top:d+"px"});function f(){$(this).removeClass("iphone-visible");$(this).addClass("iphone-invisible");$(this).unbind("click",f)}$("#iphone-text-field").click(f)}}FatalError.prototype.onError=function(b){var a=b.message;if(typeof b.message=="string"){a=a.entityify()}$("#content").append('<div class="error">An error occurred:<br/><pre>'+a+"\n\n"+b.traceback+"</pre></div>")};(function(e){var g=IFF.extend({init:function a(o,j){this.title=j;if(o[0]<9){this.filetype="ok story naked zcode";this._super();this.chunks.push({type:"ZCOD",data:o});this.zcode=o}else{if(IFF.text_from(o,0)=="FORM"){this._super(o);if(this.type=="IFRS"){for(var m=0,h=this.chunks.length;m<h;m++){var n=this.chunks[m].type;if(n=="ZCOD"&&!this.zcode){this.zcode=this.chunks[m].data}else{if(n=="IFmd"){this.metadata=file.array_to_text(this.chunks[m].data);var k=$(this.metadata);if(k){if($("title",k)){this.title=$("title",k).text()}if($("ifid",k)){this.ifid=$("ifid",k).text()}if($("release",k)){this.release=$("release",k).text()}}}}}if(this.zcode){this.filetype="ok story blorbed zcode"}else{this.filetype="error: no zcode in blorb"}}else{if(this.type=="IFZS"){this.filetype="error: trying to load a Quetzal savefile"}else{this.filetype="error unknown iff"}}}else{this.filetype="error unknown general"}}},load:function b(h){if(this.zcode){h.loadStory(this.zcode)}}});var c=Class.extend({add:function(h){this[h.ifid]=h;if(h.url){this.url[h.url]=h}},url:{}});e.Library=Class.extend({load:function(k){var h=new Querystring(),i=h.get("story",parchment.options.default_story);storyName=f(i);storyName=storyName?storyName+" - Parchment":"Parchment";e.document.title=storyName;if(this.stories.url[i]){var j=this.stories.url[i]}else{$("#progress-text").html("Retrieving story file...");if(i.slice(-3).toLowerCase()==".js"){$.getScript(i)}else{$.getScript(parchment.options.zcode_appspot_url+"?url="+escape(i)+"&jsonp=processZcodeAppspotResponse")}}},stories:new c(),savefiles:{}});function f(i){var h=i.lastIndexOf("/");return i.slice(h+1)}e.gZcode=null;e.gStory="";e.processZcodeAppspotResponse=function(h){if(h.error){throw new FatalError("Error loading story: "+h.error.entityify())}processBase64Zcode(h.data)};e.processBase64Zcode=function(l,n){var k=50000,j,h=l.slice(0,k),o=l.slice(k);if(typeof(n)=="undefined"){n=[]}$("#progress-text").html("Decoding "+l.length+" more bytes...");file.base64_decode(h,n);if(o){j=function m(){processBase64Zcode(o,n)}}else{j=function i(){gZcode=n;$("#progress-text").html("Starting interpreter...");d()}}e.setTimeout(j,1)};function d(){var k=function(){};if(e.loadFirebugConsole){e.loadFirebugConsole()}if(e.console){k=function(l){console.log(l)}}e.engine=new GnustoEngine(k);var h=new WebZui(k);var j=new EngineRunner(engine,h,k);e.story=new g(gZcode.slice(),storyName);story.load(engine);k("Story type: "+story.filetype);if(e.location.hash){var i=e.location.hash.slice(1);engine.loadSavedGame(file.base64_decode(i));k("Loading savefile")}j.run()}})(window);(function(a){var c=a.parchment;c.options={default_story:"stories/troll.z5.js",zcode_appspot_url:"http://zcode.appspot.com/"};function b(){if(a.parchment_options){$.extend(c.options,parchment_options)}var d=new Library();c.library=d;d.load();$.getScript("lib/gnusto.min.js");if(location.href.slice(0,31)=="http://parchment.googlecode.com"){$.getScript("http://www.google-analytics.com/ga.js",function(){gat._getTracker("UA-7949545-1")._trackPageview()})}}$(b)})(window);