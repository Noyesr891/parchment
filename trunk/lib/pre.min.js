function Querystring(a){this.params={};this.get=Querystring_get;if(a==null){}a=location.search.substring(1,location.search.length);if(a.length==0){return}a=a.replace(/\+/g," ");var c=a.split("&");for(var d=0;d<c.length;d++){var f=c[d].split("=");var b=unescape(f[0]);var e=(f.length==2)?unescape(f[1]):b;this.params[b]=e}}function Querystring_get(a,b){var c=this.params[a];return(c!=null)?c:b}function typeOf(b){var a=typeof b;if(a==="object"){if(b){if(typeof b.length==="number"&&!(b.propertyIsEnumerable("length"))&&typeof b.splice==="function"){a="array"}}else{a="null"}}return a}function isEmpty(c){var b,a;if(typeOf(c)==="object"){for(b in c){a=c[b];if(a!==undefined&&typeOf(a)!=="function"){return false}}}return true}String.prototype.entityify=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};String.prototype.quote=function(){var e,b,a=this.length,d='"';for(b=0;b<a;b+=1){e=this.charAt(b);if(e>=" "){if(e==="\\"||e==='"'){d+="\\"}d+=e}else{switch(e){case"\b":d+="\\b";break;case"\f":d+="\\f";break;case"\n":d+="\\n";break;case"\r":d+="\\r";break;case"\t":d+="\\t";break;default:e=e.charCodeAt();d+="\\u00"+Math.floor(e/16).toString(16)+(e%16).toString(16)}}}return d+'"'};String.prototype.supplant=function(a){return this.replace(/{([^{}]*)}/g,function(d,c){var e=a[c];return typeof e==="string"||typeof e==="number"?e:d})};String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};var base64_tab="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var base64_tab2={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,a:26,b:27,c:28,d:29,e:30,f:31,g:32,h:33,i:34,j:35,k:36,l:37,m:38,n:39,o:40,p:41,q:42,r:43,s:44,t:45,u:46,v:47,w:48,x:49,y:50,z:51,0:52,1:53,2:54,3:55,4:56,5:57,6:58,7:59,8:60,9:61,"+":62,"/":63,"=":64};function encode_base64(f){var d="",g,c,b,m,k,j,h;for(var e=0,a=f.length;e<a;){g=f[e++];c=f[e++];b=f[e++];m=g>>2;k=((g&3)<<4)+(c>>4);j=((c&15)<<2)+(b>>6);h=b&63;d+=(base64_tab.charAt(m)+base64_tab.charAt(k)+base64_tab.charAt(j)+base64_tab.charAt(h))}if(isNaN(c)){d=d.slice(0,-2)+"=="}else{if(isNaN(b)){d=d.slice(0,-1)+"="}}return d}function decode_base64(f,d){if(typeof(d)=="undefined"){d=[]}var g,c,b,m,k,j,h;for(var e=0,a=f.length;e<a;){m=base64_tab2[f.charAt(e++)];k=base64_tab2[f.charAt(e++)];j=base64_tab2[f.charAt(e++)];h=base64_tab2[f.charAt(e++)];g=(m<<2)+(k>>4);c=((k&15)<<4)+(j>>2);b=((j&3)<<6)+h;d.push(g,c,b)}if(h==64){d.pop()}if(j==64){d.pop()}return d}function FatalError(a){this.message=a;this.traceback=this._makeTraceback(arguments.callee);this.onError(this)}FatalError.prototype={onError:function(a){},_makeTraceback:function(a){var d="";var c=0;var b=100;while(a!=null&&c<b){var f=a.toString();if(!f){d="\n  (anonymous function)"+d}else{var g=f.match(/function (\w*)/);if(!g||!g[1]){d="\n  (anonymous function)"+d}else{d="\n  "+g[1]+d}}try{a=a.caller}catch(h){a=null}c++}if(c==b){d="..."+d}return"Traceback (most recent call last):\n"+d}};function iff_parse(d){function c(h){return d[h]<<24|d[h+1]<<16|d[h+2]<<8|d[h+3]}function e(h){return String.fromCharCode(d[h])+String.fromCharCode(d[h+1])+String.fromCharCode(d[h+2])+String.fromCharCode(d[h+3])}var a=[e(8)];var g=12;while(g<d.length){var b=[e(g)];var f=c(g+4);if(f<0||(f+g)>d.length){throw new FatalError("WEEBLE, panic\n");return[]}b.push(g+8);b.push(f);a.push(b);g+=8+f;if(f%2){g++}}return a}function Beret(a){this.m_engine=a}Beret.prototype={load:function b_load(l){function g(j){for(var i=0;i<j.length;i++){if(j.charCodeAt(i)!=l[i]){return false}}return true}if(l[0]<9){this.m_filetype="ok story naked zcode";this.m_engine.loadStory(l)}else{if(g("FORM")){var h=iff_parse(l);if(h.length==0){this.m_filetype="invalid unknown iff"}else{if(h[0]=="IFZS"){var d=0;var n=0;var r=0;var m=0;for(var e=1;e<h.length;e++){var q=h[e][0];if(q=="IFhd"){var k=h[e][1];var p=h[e][1]+2;if((!this.m_engine)||(this.m_engine.getByte(2)!=l[k])||(this.m_engine.getByte(3)!=l[k+1])||(this.m_engine.getByte(18)!=l[p])||(this.m_engine.getByte(19)!=l[p+1])||(this.m_engine.getByte(20)!=l[p+2])||(this.m_engine.getByte(21)!=l[p+3])||(this.m_engine.getByte(22)!=l[p+4])||(this.m_engine.getByte(23)!=l[p+5])){this.m_filetype="mismatch";break}var f=h[e][1]+10;m=l[f]<<16|l[f+1]<<8|l[f+2]}else{if(q=="Stks"){if(r!=0){throw new FatalError("fixme: error: multiple Stks\n")}r=l.slice(h[e][1],h[e][2]+h[e][1])}else{if(q=="CMem"||q=="UMem"){if(d!=0){throw new FatalError("fixme: error: multiple memory segments\n")}n=(q=="CMem");d=l.slice(h[e][1],h[e][2]+h[e][1])}}}}if(d==0){throw new FatalError("fixme: error: no memory in quetzal\n")}else{if(r==0){throw new FatalError("fixme: error: no stacks in quetzal\n")}else{if(m==0){throw new FatalError("fixme: error: no header in quetzal\n")}else{this.m_filetype="ok saved quetzal zcode";this.m_engine.loadSavedGame(d.length,d,n,r.length,r,m)}}}}else{if(h[0]=="IFRS"){this.m_filetype="invalid story blorb";var o={ZCOD:"zcode",GLUL:"glulx",TADG:"tads",ALAN:"alan",HUGO:"hugo",SAAI:"scottadams",SAII:"scottadams",MSRL:"magneticscrolls"};for(var c=1;c<h.length;c++){if(h[c][0] in o){var a=h[c][1];var b=h[c][2];this.load(l.slice(a,a+b));this.m_filetype="ok story blorb "+o[h[c][0]];return}}}else{this.m_filetype="error unknown iff"}}}}else{this.m_filetype="error unknown general"}}},filetype:function b_filetype(){return this.m_filetype},engine:function b_engine(){return this.m_engine},m_filetype:"error none unseen",m_engine:null};new function(_){var file=new base2.Package(this,{name:"file",exports:"iff, image, story"});eval(this.imports);function num_from(s,offset){return s[offset]<<24|s[offset+1]<<16|s[offset+2]<<8|s[offset+3]}function string_from(s,offset){return String.fromCharCode(s[offset])+String.fromCharCode(s[offset+1])+String.fromCharCode(s[offset+2])+String.fromCharCode(s[offset+3])}var iff=base2.Base.extend({constructor:function parse_iff(data){this.type="";this.chunks=[];if(data){if(string_from(data,0)!="FORM"){throw new FatalError("Not an IFF file!")}this.type=string_from(data,8);var i=12,l=data.length;while(i<l){var type=string_from(data,i);var chunk_length=num_from(data,i+4);if(chunk_length<0||(chunk_length+i)>data.length){throw new FatalError("WEEBLE, panic\n")}this.chunks.push({type:type,offset:i,data:data.slice(i+8,i+8+chunk_length)});i+=8+chunk_length;if(chunk_length%2){i++}}}}});var story=iff.extend({constructor:function parse_zblorb(data,story_name){this.title=story_name;if(data[0]<9){this.filetype="ok story naked zcode";this.base();this.chunks.push({type:"ZCOD",data:data});this.zcode=data}else{if(string_from(data,0)=="FORM"){this.base(data);if(this.type=="IFRS"){this.images=[];this.resources=[];for(var i=0,l=this.chunks.length;i<l;i++){var type=this.chunks[i].type;if(type=="RIdx"){for(var j=0,c=num_from(this.chunks[i].data,0);j<c;j++){this.resources.push({usage:string_from(this.chunks[i].data,4+j*12),number:num_from(this.chunks[i].data,8+j*12),start:num_from(this.chunks[i].data,12+j*12)})}}else{if(type=="ZCOD"&&!this.zcode){this.zcode=this.chunks[i].data}else{if(type=="IFmd"){this.metadata=String.fromCharCode.apply(this,this.chunks[i].data);var metadataDOM=$(this.metadata);if(metadataDOM){this.metadataDOM=metadataDOM;if($("title",metadataDOM)){this.title=$("title",metadataDOM).text()}if($("ifid",metadataDOM)){this.ifid=$("ifid",metadataDOM).text()}}}else{if(type=="PNG "||type=="JPEG"){for(var j=0,c=this.resources.length;j<c;j++){if(this.resources[j].usage=="Pict"&&this.resources[j].start==this.chunks[i].offset){this.images[this.resources[j].number]=new image(this.chunks[i])}}}else{if(type=="Fspc"){this.frontispiece=num_from(this.chunks[i].data,0)}}}}}}if(this.zcode){this.filetype="ok story blorbed zcode"}else{this.filetype="error: no zcode in blorb"}}else{if(this.type=="IFZS"){this.filetype="error: trying to load a Quetzal savefile"}else{this.filetype="error unknown iff"}}}else{this.filetype="error unknown general"}}},load:function loadIntoEngine(engine){if(this.zcode){engine.loadStory(this.zcode)}window.document.title=this.title+" - Parchment"}});var image=base2.Base.extend({constructor:function init_image(chunk){this.chunk=chunk;this.dataURI=function create_dataURI(){var encoded=encode_base64(this.chunk.data);if(this.chunk.type=="PNG "){this.URI="data:image/png;base64,"+encoded}else{if(this.chunk.type=="JPEG"){this.URI="data:image/jpeg;base64,"+encoded}}this.dataURI=function(){return this.URI};return this.URI}}});eval(this.exports)};