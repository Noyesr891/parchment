/*
 * Parchment Z-Machine UI and Runner
 * Built: 2010-06-30
 *
 * Copyright (c) 2008-2010 The Parchment Contributors
 * Licenced under the GPL v2
 * http://code.google.com/p/parchment
 */
(function(i){var a=27;var t=8;var g=13;var k=16;var b=37;var x=38;var r=39;var c=40;var d=33,e=34;var v=129;var p=130;var m=131;var n=132;var h=13;var w=8;var s=27;var o={BACKSPACE_KEYCODE:"backwardDeleteChar",LEFT_KEYCODE:"backwardChar",UP_KEYCODE:"previousHistory",RIGHT_KEYCODE:"forwardChar",DOWN_KEYCODE:"nextHistory"};var q={RETURN_KEYCODE:h,BACKSPACE_KEYCODE:w,ESCAPE_KEYCODE:s,LEFT_KEYCODE:m,UP_KEYCODE:v,RIGHT_KEYCODE:n,DOWN_KEYCODE:p};function u(A,z){var y={};for(name in A){y[z[name]]=A[name]}return y}var j=u(o,this);var l=u(q,this);function f(){this.line="";this.pos=0;this._history=[""];this._savedHistory={};this._historyPos=0;var y=this;this.acceptLine=function(){var z=y.line;y.line="";y.pos=0;for(var A in y._savedHistory){y._history[A]=y._savedHistory[A]}y._savedHistory={};if(z.length>0){y._history[y._history.length-1]=z;y._history.push("")}y._historyPos=y._history.length-1;return z};this.forwardChar=function(){if(y.pos<y.line.length){y.pos++}};this.backwardChar=function(){if(y.pos>0){y.pos--}};this.backwardDeleteChar=function(){if(y.pos>0){var A=y.line.slice(0,y.pos-1);var z=y.line.slice(y.pos);if(z.charAt(0)==" "&&A.charAt(A.length-1)==" "){z=z.slice(1)}y.line=A+z;y.pos--}};this.selfInsert=function(A){var z=String.fromCharCode(A);if(z==" "){if(y.pos>0&&y.line.charAt(y.pos-1)==" "){return}else{if(y.pos<y.line.length&&y.line.charAt(y.pos)==" "){return}}}y.line=(y.line.slice(0,y.pos)+z+y.line.slice(y.pos));y.pos++};this._saveHistoryExcursion=function(){if(y._history[y._historyPos]!=y._line){if(!(y._historyPos in y._savedHistory)){y._savedHistory[y._historyPos]=y._history[y._historyPos]}y._history[y._historyPos]=y.line}};this.previousHistory=function(){if(y._historyPos<=0){return}y._saveHistoryExcursion();y._historyPos--;y.line=y._history[y._historyPos];y.pos=y.line.length};this.nextHistory=function(){if(y._historyPos+1>=y._history.length){return}y._saveHistoryExcursion();y._historyPos++;y.line=y._history[y._historyPos];y.pos=y.line.length}}parchment.lib.ZUI=Class.extend({init:function(A,C,D){var z=this,y=(gIsIphone&&i(document.body).width()<=480)?38:80;A.container.html('<div id="top-window" class="buffered-window"></div><div id="buffered-windows"></div><div id="content"></div><div id="bottom"></div>');i.extend(z,{_size:[y,25],_console:null,_activeWindow:0,_currentCallback:null,_foreground:"default",_background:"default",_reverseVideo:false,_lastSeenY:0,_currStyles:["z-roman"],_expectedHash:window.location.hash,_isFixedWidth:false,_bufferMode:0,library:A,engine:C,bottom:i("#bottom"),current_input:i("#current-input"),_log:D||i.noop,_windowHashCheck:function(){if(window.location.hash!=z._expectedHash){z._restart()}}});z._setFixedPitchSizes();i("#top-window").css({width:z._pixelWidth+"px",lineHeight:z._pixelLineHeight+"px"});i("#content").css({width:z._pixelWidth+"px"});z._windowResize();z._bindEventHandlers();z._eraseBottomWindow();if(gIsIphone){i(document.body).append('<textarea class="iphone-visible" id="iphone-text-field" rows="1" cols="20" autocapitalize="off">Tap here to enter text.</textarea>');var B=-1*i("#iphone-text-field").height();i("#iphone-text-field").css({top:B+"px"});function E(){i(this).removeClass("iphone-visible");i(this).addClass("iphone-invisible");i(this).unbind("click",E)}i("#iphone-text-field").click(E)}},onConsoleRender:function(){var y=i("#top-window").height();i("#content").css({padding:""+y+"px 0 0 0"});this._scrollBottomWindow()},_scrollBottomWindow:function(){if(!gIsIphone){window.scroll(0,this._lastSeenY)}},_finalize:function(){var y=this;if(y._console){y._console.close();y._console=null}i("#content").empty();y._unbindEventHandlers()},_bindEventHandlers:function(){var y=this;if(gIsIphone){i(document).keyup(y._iphoneKeyup)}else{i(document).bind("keydown","Ctrl+v",y._windowPasteHandler).keypress(y._windowKeypress).keyup(y._windowKeyup).keydown(y._windowKeydown)}i(window).resize(y._windowResize);y._intervalId=window.setInterval(y._windowHashCheck,1000)},_unbindEventHandlers:function(){var y=this;if(gIsIphone){i(document).unbind("keyup",y._iphoneKeyup)}else{i(document).unbind("keydown","Ctrl+v",y._windowPasteHandler).unbind("keypress",y._windowKeypress).unbind("keyup",y._windowKeyup).unbind("keydown",y._windowKeydown)}i(window).unbind("resize",y._windowResize);window.clearInterval(y._intervalId)},_isHotKey:function(y){return(y.altKey||y.ctrlKey||y.metaKey||y.keyCode==d||y.keyCode==e)},_iphoneKeyup:function(y){i("#iphone-text-field").val("");var z=new Object();switch(y.keyCode){case 127:case 8:z.keyCode=t;break;case 10:case 13:z.keyCode=g;break;default:z.charCode=y.keyCode}return self._handleKeyEvent(z)},_windowKeyup:function(y){if(jQuery.browser.mozilla){return self._isHotKey(y)}else{return true}},_windowKeydown:function(y){if(jQuery.browser.mozilla){return self._isHotKey(y)}else{if(((jQuery.browser.safari||jQuery.browser.msie)&&(!jQuery.browser.opera)&&(y.keyCode==b||y.keyCode==x||y.keyCode==r||y.keyCode==c||y.keyCode==t))){return self._handleKeyEvent(y)}else{return true}}},_windowKeypress:function(y){if(self._isHotKey(y)){return true}if(jQuery.browser.mozilla){return self._handleKeyEvent(y)}else{var z=new Object();if(jQuery.browser.opera){z.charCode=y.which;if(y.which!=b&&y.which!=r&&y.which!=x&&y.which!=c){z.keyCode=y.keyCode}}else{if(jQuery.browser.safari){if(y.charCode&&y.keyCode!=g){z.charCode=y.charCode}else{z.keyCode=y.keyCode}}else{if(jQuery.browser.msie){if(y.keyCode==g){z.keyCode=y.keyCode}else{z.charCode=y.keyCode}}}}return self._handleKeyEvent(z)}},_handleKeyEvent:function(y){if(y.keyCode==k){return false}self._removeBufferedWindows();self._lastSeenY=self.bottom.offset().top;self._scrollBottomWindow();if(self.current_input.length==0){if(self._currentCallback){var H=0;if(y.charCode){H=y.charCode}else{if(l[y.keyCode]){H=l[y.keyCode]}}if(H!=0){var G=self._currentCallback;self._currentCallback=null;G(H)}}return false}var A=self._lineEditor.line;var z=self._lineEditor.pos;if(y.keyCode==g){var C=self._lineEditor.acceptLine();var G=self._currentCallback;self._currentCallback=null;self._lastSeenY=self.current_input.offset().top;var I=self.current_input.attr("class");self.current_input.replaceWith(('<span class="finished-input '+I+'">'+C.entityify()+"</span><br/>"));self.current_input=i("#current-input");G(C)}else{if(y.keyCode in j){self._lineEditor[j[y.keyCode]]()}else{if(y.charCode){self._lineEditor.selfInsert(y.charCode)}}}if(self.current_input&&(A!=self._lineEditor.line||z!=self._lineEditor.pos)){var B=self._lineEditor.line.slice(0,self._lineEditor.pos);var F;var E;var D;if(self._lineEditor.line.length<=self._lineEditor.pos){F="";E="_";D="cursor"}else{F=self._lineEditor.line.slice(self._lineEditor.pos+1);E=self._lineEditor.line.charAt(self._lineEditor.pos);D="editing-cursor";if(E==" "){E="&nbsp;"}else{E=E.entityify()}}self.current_input.html(B.entityify()+'<span id="'+D+'">'+E+"</span>"+F.entityify())}return false},_windowPasteHandler:function(y){if(self.current_input.length!=0){i("#pasteinput").focus();window.setTimeout(self._inputPasteHandler,10)}},_inputPasteHandler:function(A){var z=i("#pasteinput").val();i("#pasteinput").val("");var B={charCode:0,keyCode:0};for(var y=0;y<z.length;y++){B.charCode=z.charCodeAt(y);self._handleKeyEvent(B)}},_windowResize:function(){var y=i("#content").offset().left+"px";i(".buffered-window").css({left:y})},_removeBufferedWindows:function(){var y=i("#buffered-windows > .buffered-window");y.fadeOut("slow",function(){y.remove()})},_eraseBottomWindow:function(){i("#content").empty();this._lastSeenY=0},_restart:function(){this._finalize();location.reload()},setVersion:function(y){this._version=y},getSize:function(){return this._size},onLineInput:function(B){var y=this;if(y.engine.m_version<=3){var z=y._activeWindow;var A=y._reverseVideo;if(!y._console){y.onSplitWindow(1)}y._console.moveTo(0,0);y._activeWindow=1;y._reverseVideo=true;y.onPrint(y.engine.getStatusLine(y._console.width));y._reverseVideo=A;y._activeWindow=z}y._currentCallback=B;i("#content").append('<span id="current-input"><span id="cursor">_</span></span>');y.current_input=i("#current-input");y.current_input.attr("class",y._calcFinalStyles())},onCharacterInput:function(y){this._currentCallback=y},onSave:function(B){var y=this,A=this.library.url+"_saveData",z=file.base64_encode(B);if(window.globalStorage&&location.href.slice(0,5)!="file:"){window.globalStorage[location.hostname][A]=z}location=location.protocol+"//"+location.host+location.pathname+location.search+"#"+z;y._expectedHash=location.hash;y.onPrint("Your game has been saved to the URL. You may want to bookmark this page now; just reload it at any time to restore your game from this point.\n");return true},onRestore:function(){var z=null;if(location.hash){z=location.hash.slice(1)}if(!z&&window.globalStorage){var y=globalStorage[location.hostname][this.library.url+"_saveData"];if(y){z=y.value;location=location.protocol+"//"+location.host+location.pathname+location.search+"#"+z;this._expectedHash=location.hash}}if(z){return file.base64_decode(z)}else{return null}},onQuit:function(){this._finalize()},onRestart:function(){var y=this;y._finalize();window.location.hash="";y._restart()},onWimpOut:function(y){window.setTimeout(y,50)},onFlagsChanged:function(y,z){if(y){throw new FatalError("To transcript not yet implemented!")}this._isFixedWidth=z},onSetStyle:function(B,A,z){switch(B){case -1:break;case 0:this._currStyles=["z-roman"];this._reverseVideo=false;break;case 1:this._reverseVideo=true;break;case 2:this._currStyles.push("z-bold");break;case 4:this._currStyles.push("z-italic");break;case 8:this._currStyles.push("z-fixed-pitch");break;default:throw new FatalError("Unknown style: "+B)}var y={0:null,1:"default",2:"black",3:"red",4:"green",5:"yellow",6:"blue",7:"magenta",8:"cyan",9:"white"};if(y[A]){this._foreground=y[A]}if(y[z]){this._background=y[z]}},onSetWindow:function(z){var y=this;if(z==1){if(!y._console){y.onSplitWindow(1)}y._console.moveTo(0,0)}y._activeWindow=z},onEraseWindow:function(z){var y=this;document.body.className="bg-"+y._background;if(z==-2){y._console.clear();y._eraseBottomWindow()}else{if(z==-1){y.onSplitWindow(0);y._eraseBottomWindow()}else{if(z==0){y._eraseBottomWindow()}else{if(z==1&&y._console){y._console.clear()}}}}},onSetCursor:function(z,B){var A=this;if(A._console){A._console.moveTo(z-1,B-1)}},onSetBufferMode:function(y){this._bufferMode=y},onSplitWindow:function(A){var y=this;if(A==0){if(y._console){y._console.close();y._console=null}}else{if(!y._console||y._version==3||!y._bufferMode){y._console=new Console(y._size[0],A,i("#top-window").get(0),y)}else{if(y._console.height!=A){var z=document.createElement("div");z.className="buffered-window";z.innerHTML=y._console.renderHtml();i(z).css({width:y._pixelWidth+"px",lineHeight:y._pixelLineHeight+"px"});i("#buffered-windows").append(z);y._windowResize();y._console.resize(A)}}}y._bufferMode=0},_calcFinalStyles:function(){var A=this,z=A._foreground,B=A._background;if(A._reverseVideo){z=A._background;B=A._foreground;if(z=="default"){z="default-reversed"}if(B=="default"){B="default-reversed"}}var y=["fg-"+z,"bg-"+B];if(A._isFixedWidth){y.push("z-fixed-pitch")}return y.concat(A._currStyles).join(" ")},onPrint:function(z){var E=this,D=E._calcFinalStyles();E._log("print wind: "+E._activeWindow+" output: "+z.quote()+" style: "+D);if(E._activeWindow==0){var G=z.split("\n");for(var A=0;A<G.length;A++){if(G[A]){var C=G[A].entityify();var B=/ /g,F=/(\S) (\S)/g,y=/<&>/g;C=C.replace(F,"$1<&>$2");C=C.replace(B,"&nbsp;");C=C.replace(y,'<span class="z-breaking-whitespace"> </span>');C='<span class="'+D+'">'+C+"</span>";i("#content").append(C)}if(A<G.length-1){i("#content").append("<br/>")}}E._scrollBottomWindow()}else{E._console.write(z,D)}},onPrintTable:function(y){for(var z=0;z<y.length;z++){this.onPrint(y[z])}},_setFixedPitchSizes:function(){var z=this,C=document.createElement("div");C.className="buffered-window";for(var B=0;B<z._size[0];B++){C.innerHTML+="O"}C.innerHTML="<span>"+C.innerHTML+"</span>";i("#buffered-windows").append(C);z._pixelWidth=i(C).width();if(jQuery.browser.msie&&(jQuery.browser.version.length==1||jQuery.browser.version.charAt(1)==".")&&jQuery.browser.version<"7"){var A=-1,y=document.getElementById("top-window").currentStyle.fontSize.toLowerCase();if(y.substring(y.length-2)=="px"){A=0.6*parseInt(y)}else{if(y.substring(y.length-2)=="pt"){A=0.8*parseInt(y)}}if(A>0){z._pixelWidth=z._size[0]*A}}z._pixelLineHeight=i(C.firstChild).height();i("#buffered-windows").empty()}})})(jQuery);window.Quetzal=IFF.subClass({init:function(b){this._super(b);if(b){if(this.type!="IFZS"){throw new Error("Not a Quetzal savefile")}for(var c=0,a=this.chunks.length;c<a;c++){var d=this.chunks[c].type,e=this.chunks[c].data;if(d=="CMem"||d=="UMem"){this.memory=e;this.compressed=(d=="CMem")}else{if(d=="Stks"){this.stacks=e}else{if(d=="IFhd"){this.release=e.slice(0,2);this.serial=e.slice(2,8);this.checksum=e.slice(8,10);this.pc=e[10]<<16|e[11]<<8|e[12]}}}}}},write:function(){this.type="IFZS";var b=this.pc,a=this.release.concat(this.serial,this.checksum,(b>>16)&255,(b>>8)&255,b&255);this.chunks=[{type:"IFhd",data:a},{type:(this.compressed?"CMem":"UMem"),data:this.memory},{type:"Stks",data:this.stacks}];return this._super()}});function EngineRunner(d,c,e){this._engine=d;this._zui=c;this._isRunning=false;this._isInLoop=false;this._isWaitingForCallback=false;this._log=e;var b=this;var a={stop:function(){b._isRunning=false},run:function(){var f=b._zui.getSize();b._zui.setVersion(b._engine.m_version);b._isRunning=true;b._engine.m_memory[32]=f[1];b._engine.m_memory[33]=f[0];b._continueRunning()},_continueRunning:function(){while(b._isRunning&&!b._isWaitingForCallback){b._loop()}},_receiveLineInput:function(f){b._isWaitingForCallback=false;b._engine.answer(0,13);b._engine.answer(1,f);if(!b._isInLoop){b._continueRunning()}else{}},_receiveCharacterInput:function(f){b._isWaitingForCallback=false;b._engine.answer(0,f);if(!b._isInLoop){b._continueRunning()}else{}},_unWimpOut:function(){b._isWaitingForCallback=false;if(!b._isInLoop){b._continueRunning()}else{}},_loop:function(){if(b._isInLoop){throw new FatalError("Already in loop!")}b._isInLoop=true;var k=b._engine;k.run();var n=k.consoleText();if(n){b._zui.onPrint(n)}var p='"'+k.effect(0)+'"';var g="[ "+k.effect(0);for(var h=1;k.effect(h)!=undefined;h++){var m=k.effect(h);if(typeof m=="string"){m=m.quote()}g+=", "+m}b._log(g+" ]");switch(p){case GNUSTO_EFFECT_INPUT:b._isWaitingForCallback=true;b._zui.onLineInput(b._receiveLineInput);break;case GNUSTO_EFFECT_INPUT_CHAR:b._isWaitingForCallback=true;b._zui.onCharacterInput(b._receiveCharacterInput);break;case GNUSTO_EFFECT_SAVE:k.saveGame();if(b._zui.onSave(k.saveGameData())){k.answer(0,1)}else{k.answer(0,0)}break;case GNUSTO_EFFECT_RESTORE:var q=b._zui.onRestore();if(q){k.loadSavedGame(q)}else{k.answer(0,0)}break;case GNUSTO_EFFECT_QUIT:b.stop();b._zui.onQuit();break;case GNUSTO_EFFECT_RESTART:b.stop();b._zui.onRestart();break;case GNUSTO_EFFECT_WIMP_OUT:b._isWaitingForCallback=true;b._zui.onWimpOut(b._unWimpOut);break;case GNUSTO_EFFECT_BREAKPOINT:throw new FatalError("Unimplemented effect: "+p);case GNUSTO_EFFECT_FLAGS_CHANGED:var j=k.m_printing_header_bits&1;var l=k.m_printing_header_bits&2;b._zui.onFlagsChanged(j,l);break;case GNUSTO_EFFECT_PIRACY:throw new FatalError("Unimplemented effect: "+p);case GNUSTO_EFFECT_STYLE:b._zui.onSetStyle(k.effect(1),k.effect(2),k.effect(3));break;case GNUSTO_EFFECT_SOUND:break;case GNUSTO_EFFECT_SPLITWINDOW:b._zui.onSplitWindow(k.effect(1));break;case GNUSTO_EFFECT_SETWINDOW:b._zui.onSetWindow(k.effect(1));break;case GNUSTO_EFFECT_ERASEWINDOW:b._zui.onEraseWindow(k.effect(1));break;case GNUSTO_EFFECT_ERASELINE:throw new FatalError("Unimplemented effect: "+p);case GNUSTO_EFFECT_SETCURSOR:b._zui.onSetCursor(k.effect(2),k.effect(1));break;case GNUSTO_EFFECT_SETBUFFERMODE:b._zui.onSetBufferMode(k.effect(1));break;case GNUSTO_EFFECT_SETINPUTSTREAM:case GNUSTO_EFFECT_GETCURSOR:throw new FatalError("Unimplemented effect: "+p);break;case GNUSTO_EFFECT_PRINTTABLE:var f=k.effect(1);var o=[];for(h=0;h<f;h++){o.push(k.effect(2+h))}b._zui.onPrintTable(o);break}b._isInLoop=false}};for(name in a){b[name]=a[name]}}function Console(d,a,c,b){this.width=d;this.height=a;this._element=c;this._pos=[0,0];this._observer=b;this._isRenderScheduled=false;this.clear()}Console.prototype={resize:function(a){var b=a-this.height;if(b==0){return}var c;if(b>0){for(c=0;c<b;c++){this._addRow()}}else{for(c=0;c<-b;c++){this._delRow()}}this.height=a;this._scheduleRender()},_delRow:function(){this._characters.pop();this._styles.pop()},_addRow:function(){var b=[];var c=[];for(var a=0;a<this.width;a++){b.push("&nbsp;");c.push(null)}this._characters.push(b);this._styles.push(c)},clear:function(){this._characters=[];this._styles=[];for(var a=0;a<this.height;a++){this._addRow()}this._scheduleRender()},moveTo:function(a,b){this._pos=[a,b]},write:function(b,d){var a=this._pos[0];var f=this._pos[1];for(var c=0;c<b.length;c++){var e=null;if(b.charAt(c)==" "){e="&nbsp;"}else{if(b.charAt(c)=="\n"){a=0;f+=1}else{e=b.charAt(c).entityify()}}if(f>this.height-1){this.resize(f+1)}if(e!=null){this._characters[f][a]=e;this._styles[f][a]=d;a+=1}}this._pos=[a,f];this._scheduleRender()},_scheduleRender:function(){if(!this._isRenderScheduled){this._isRenderScheduled=true;var a=this;window.setTimeout(function(){a._doRender()},0)}},renderHtml:function(){var c="";for(var d=0;d<this.height;d++){var b=null;for(var a=0;a<this.width;a++){if(this._styles[d][a]!==b){if(b!==null){c+="</span>"}b=this._styles[d][a];if(b!==null){c+='<span class="'+b+'">'}}c+=this._characters[d][a]}if(b!==null){c+="</span>"}c+="<br/>"}return c},_doRender:function(){this._element.innerHTML=this.renderHtml();this._isRenderScheduled=false;this._observer.onConsoleRender()},close:function(){this._element.innerHTML="";this._observer.onConsoleRender()}};